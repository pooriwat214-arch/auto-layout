<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>AUTO LAYOUT – Production</title>

<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/utif@3.1.0/UTIF.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial;
  background:#eef1f5;
  display:flex;
  flex-direction:column;
  height:100vh;
}

.topbar{
  background:#0f1f3d;
  color:white;
  padding:14px 20px;
  font-weight:600;
}

.main{
  flex:1;
  display:flex;
  overflow:hidden;
}

#controls{
  width:320px;
  padding:20px;
  background:white;
  border-right:1px solid #ddd;
}

input{
  width:100%;
  padding:8px;
  margin-bottom:10px;
}

button{
  width:100%;
  padding:10px;
  margin-top:6px;
  background:#1f3c88;
  color:white;
  border:none;
  cursor:pointer;
}

#workspace{
  flex:1;
  padding:20px;
  overflow:auto;
}

.canvas-wrapper{
  background:white;
  padding:20px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
</style>
</head>

<body>

<div class="topbar">
AUTO LAYOUT – Production Version
</div>

<div class="main">

<div id="controls">

<label>Carpet Width (m)</label>
<input type="number" id="width" value="4">

<label>Carpet Length (m)</label>
<input type="number" id="length" value="40">

<label>Gap (cm)</label>
<input type="number" id="gap" value="10">

<label>Upload Images</label>
<input type="file" id="upload" multiple>

<button onclick="autoLayout()">Smart Auto Layout</button>
<button onclick="exportPDF()">Export Production PDF</button>

<div style="margin-top:15px;font-weight:bold;">
Used Area: <span id="usedArea">0%</span>
</div>

<div>
Carpet Size: <span id="carpetSize">0 x 0 cm</span>
</div>

</div>

<div id="workspace">
<div class="canvas-wrapper">
<div id="container"></div>
</div>
</div>

</div>

<script>

const SCALE = 0.1;
let stage, layer;

function initStage(){

  const widthCm = document.getElementById('width').value*100;
  const lengthCm = document.getElementById('length').value*100;

  const widthPx = widthCm * SCALE;
  const heightPx = lengthCm * SCALE;

  document.getElementById("container").innerHTML="";

  stage = new Konva.Stage({
    container:'container',
    width:widthPx,
    height:heightPx
  });

  layer = new Konva.Layer();
  stage.add(layer);

  const carpet = new Konva.Rect({
    x:0,y:0,
    width:widthPx,
    height:heightPx,
    fill:"#ffffff",
    stroke:"#000",
    strokeWidth:2
  });

  layer.add(carpet);
  layer.draw();
  updateAreaUsage();
}

initStage();
document.getElementById('width').onchange=initStage;
document.getElementById('length').onchange=initStage;

document.getElementById('upload').addEventListener('change', function(e){

  Array.from(e.target.files).forEach(file => {

    const fileName = file.name.toLowerCase();

    if(fileName.endsWith(".tif") || fileName.endsWith(".tiff")){

      const reader = new FileReader();

      reader.onload = function(event){

        const buffer = event.target.result;
        const ifds = UTIF.decode(buffer);
        UTIF.decodeImages(buffer, ifds);

        const firstPage = ifds[0];
        const rgba = UTIF.toRGBA8(firstPage);

        const canvas = document.createElement("canvas");
        canvas.width = firstPage.width;
        canvas.height = firstPage.height;

        const ctx = canvas.getContext("2d");
        const imageData = ctx.createImageData(firstPage.width, firstPage.height);
        imageData.data.set(rgba);
        ctx.putImageData(imageData, 0, 0);

        const imgObj = new Image();
        imgObj.onload = function(){

          const img = new Konva.Image({
            image: imgObj,
            x:0,
            y:0,
            width:200,
            height:200,
            draggable:true,
            dragBoundFunc:function(pos){
              return{
                x:Math.max(0,Math.min(pos.x,stage.width()-this.width())),
                y:Math.max(0,Math.min(pos.y,stage.height()-this.height()))
              };
            }
          });

          layer.add(img);
          layer.draw();
          updateAreaUsage();
        };

        imgObj.src = canvas.toDataURL("image/png");
      };

      reader.readAsArrayBuffer(file);

    } else {

      // JPG / PNG ปกติ
      const reader = new FileReader();

      reader.onload = function(evt){
        const imgObj = new Image();
        imgObj.onload = function(){

          const img = new Konva.Image({
            image: imgObj,
            x:0,
            y:0,
            width:200,
            height:200,
            draggable:true,
            dragBoundFunc:function(pos){
              return{
                x:Math.max(0,Math.min(pos.x,stage.width()-this.width())),
                y:Math.max(0,Math.min(pos.y,stage.height()-this.height()))
              };
            }
          });

          layer.add(img);
          layer.draw();
          updateAreaUsage();
        };

        imgObj.src = evt.target.result;
      };

      reader.readAsDataURL(file);
    }

  });

});
        layer.add(img);
        layer.draw();
        updateAreaUsage();
      };
      imgObj.src=evt.target.result;
    };
    reader.readAsDataURL(file);
  });
});

function autoLayout(){

  const gap = document.getElementById('gap').value * SCALE;

  const freeRects=[{
    x:0,y:0,
    width:stage.width(),
    height:stage.height()
  }];

  const images=layer.children.filter(n=>n.className==="Image");

  images.sort((a,b)=>(b.width()*b.height())-(a.width()*a.height()));

  images.forEach(img=>{
    for(let i=0;i<freeRects.length;i++){
      const r=freeRects[i];
      if(img.width()+gap<=r.width && img.height()+gap<=r.height){

        img.position({x:r.x,y:r.y});

        freeRects.splice(i,1);

        freeRects.push({
          x:r.x+img.width()+gap,
          y:r.y,
          width:r.width-img.width()-gap,
          height:img.height()+gap
        });

        freeRects.push({
          x:r.x,
          y:r.y+img.height()+gap,
          width:r.width,
          height:r.height-img.height()-gap
        });

        break;
      }
    }
  });

  layer.draw();
  updateAreaUsage();
}

function updateAreaUsage(){

  const widthCm=document.getElementById('width').value*100;
  const lengthCm=document.getElementById('length').value*100;
  const carpetArea=widthCm*lengthCm;

  let used=0;

  layer.children.forEach(n=>{
    if(n.className==="Image"){
      used+=(n.width()/SCALE/100)*(n.height()/SCALE/100);
    }
  });

  document.getElementById("usedArea").innerText=
  ((used/carpetArea)*100).toFixed(2)+"%";

  document.getElementById("carpetSize").innerText=
  widthCm+" x "+lengthCm+" cm";
}

async function exportPDF(){

  const { jsPDF } = window.jspdf;

  const widthCm=document.getElementById('width').value*100;
  const lengthCm=document.getElementById('length').value*100;

  const pageHeight=200;
  const totalPages=Math.ceil(lengthCm/pageHeight);

  const doc=new jsPDF({
    orientation:"portrait",
    unit:"cm",
    format:[widthCm,pageHeight]
  });

  for(let p=0;p<totalPages;p++){

    if(p>0) doc.addPage([widthCm,pageHeight]);

    const pageTop=p*pageHeight;
    const pageBottom=pageTop+pageHeight;

    for(let node of layer.children){

      if(node.className!=="Image") continue;

      const realX=node.x()/SCALE/100;
      const realY=node.y()/SCALE/100;
      const realW=node.width()/SCALE/100;
      const realH=node.height()/SCALE/100;

      const imgTop=realY;
      const imgBottom=realY+realH;

      if(imgBottom>pageTop && imgTop<pageBottom){

        const visibleTop=Math.max(imgTop,pageTop);
        const visibleBottom=Math.min(imgBottom,pageBottom);
        const visibleHeight=visibleBottom-visibleTop;

        const cropStartPx=(visibleTop-imgTop)*100*SCALE;
        const cropHeightPx=visibleHeight*100*SCALE;

        const canvas=document.createElement("canvas");
        canvas.width=node.width();
        canvas.height=cropHeightPx;

        const ctx=canvas.getContext("2d");

        ctx.drawImage(
          node.image(),
          0,
          cropStartPx,
          node.width(),
          cropHeightPx,
          0,
          0,
          node.width(),
          cropHeightPx
        );

        doc.addImage(
          canvas.toDataURL("image/jpeg"),
          "JPEG",
          realX,
          visibleTop-pageTop,
          realW,
          visibleHeight
        );
      }
    }
  }

  window.open(doc.output("bloburl"));
}

</script>
</body>
</html>
