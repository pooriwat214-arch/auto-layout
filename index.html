<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>AUTO LAYOUT</title>

<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial;
  background:#eef1f5;
  display:flex;
  flex-direction:column;
  height:100vh;
}

.topbar{
  background:#0f1f3d;
  color:white;
  padding:15px 20px;
  font-weight:bold;
  letter-spacing:1px;
}

.main{
  flex:1;
  display:flex;
  overflow:hidden;
}

#controls{
  width:320px;
  padding:20px;
  background:white;
  border-right:1px solid #ddd;
}

input{
  width:100%;
  padding:8px;
  margin-bottom:10px;
}

button{
  width:100%;
  padding:10px;
  margin-top:5px;
  background:#1f3c88;
  color:white;
  border:none;
  cursor:pointer;
}

#workspace{
  flex:1;
  padding:20px;
  overflow:auto;
}

.canvas-wrapper{
  background:white;
  padding:20px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
  background-image: repeating-linear-gradient(
    45deg,
    #f5f7fa,
    #f5f7fa 10px,
    #e9edf2 10px,
    #e9edf2 20px
  );
}
</style>
</head>

<body>

<div class="topbar">
AUTO LAYOUT â€“ Carpet Layout Management Tool
</div>

<div class="main">

<div id="controls">

<label>Carpet Width (m)</label>
<input type="number" id="width" value="4">

<label>Carpet Length (m)</label>
<input type="number" id="length" value="40">

<label>Gap (cm)</label>
<input type="number" id="gap" value="10">

<label>Upload Images</label>
<input type="file" id="upload" multiple>

<button onclick="autoLayout()">Auto Layout</button>
<button onclick="exportPDF()">Export PDF</button>
<button onclick="lockImage()">Lock / Unlock</button>
<button onclick="deleteImage()">Delete Selected</button>

<div style="margin-top:20px;font-weight:bold;">
Used Area: <span id="usedArea">0%</span>
</div>

<div>
Carpet Size: <span id="carpetSize">0 x 0 cm</span>
</div>

</div>

<div id="workspace">
<div class="canvas-wrapper">
<div id="container"></div>
</div>
</div>

</div>

<script>

const SCALE = 0.1;
let stage, layer;
let selectedNode = null;

function initStage(){

  const widthCm = document.getElementById('width').value * 100;
  const lengthCm = document.getElementById('length').value * 100;

  const widthPx = widthCm * SCALE;
  const heightPx = lengthCm * SCALE;

  document.getElementById("container").innerHTML="";

  stage = new Konva.Stage({
    container:'container',
    width:widthPx,
    height:heightPx
  });

  layer = new Konva.Layer();
  stage.add(layer);

  const carpet = new Konva.Rect({
    x:0,
    y:0,
    width:widthPx,
    height:heightPx,
    fill:"#ffffff",
    stroke:"#0f1f3d",
    strokeWidth:2
  });

  layer.add(carpet);

  drawPageLines(lengthCm);
  updateAreaUsage();
}

function drawPageLines(totalCm){

  const pageHeightPx = 200 * SCALE;
  const totalPages = Math.floor(totalCm/200);

  for(let i=1;i<=totalPages;i++){
    const line = new Konva.Line({
      points:[0, i*pageHeightPx, stage.width(), i*pageHeightPx],
      stroke:"red",
      dash:[5,5]
    });
    layer.add(line);
  }
}

initStage();
document.getElementById('width').onchange=initStage;
document.getElementById('length').onchange=initStage;

document.getElementById('upload').addEventListener('change',function(e){

  Array.from(e.target.files).forEach(file=>{
    const reader=new FileReader();

    reader.onload=function(evt){
      const imgObj=new Image();

      imgObj.onload=function(){

        const img=new Konva.Image({
          image:imgObj,
          x:0,
          y:0,
          width:200,
          height:200,
          draggable:true,
          dragBoundFunc:function(pos){
            return{
              x:Math.max(0,Math.min(pos.x,stage.width()-this.width())),
              y:Math.max(0,Math.min(pos.y,stage.height()-this.height()))
            };
          }
        });

        img.on("click",()=>selectedNode=img);
        img.on("dragend",updateAreaUsage);

        layer.add(img);
        layer.draw();
        updateAreaUsage();
      };

      imgObj.src=evt.target.result;
    };

    reader.readAsDataURL(file);
  });

});

function autoLayout(){

  const gap = document.getElementById('gap').value * SCALE;
  let x=0,y=0,rowHeight=0;

  layer.children.forEach(node=>{

    if(node.className!=="Image") return;

    if(x+node.width()>stage.width()){
      x=0;
      y+=rowHeight+gap;
      rowHeight=0;
    }

    if(y+node.height()>stage.height()) return;

    node.position({x,y});
    x+=node.width()+gap;
    rowHeight=Math.max(rowHeight,node.height());
  });

  layer.draw();
  updateAreaUsage();
}

function lockImage(){
  if(!selectedNode) return;
  selectedNode.draggable(!selectedNode.draggable());
}

function deleteImage(){
  if(!selectedNode) return;
  selectedNode.destroy();
  selectedNode=null;
  layer.draw();
  updateAreaUsage();
}

function updateAreaUsage(){

  const widthCm=document.getElementById('width').value*100;
  const lengthCm=document.getElementById('length').value*100;
  const carpetArea=widthCm*lengthCm;

  let used=0;

  layer.children.forEach(node=>{
    if(node.className==="Image"){
      used+=(node.width()/SCALE/100)*(node.height()/SCALE/100);
    }
  });

  const percent=((used/carpetArea)*100).toFixed(2);

  document.getElementById("usedArea").innerText=percent+"%";
  document.getElementById("carpetSize").innerText=
  widthCm+" x "+lengthCm+" cm";
}

async function exportPDF(){

  const { jsPDF } = window.jspdf;

  const widthCm=document.getElementById('width').value*100;
  const lengthCm=document.getElementById('length').value*100;

  const pageHeight=200;
  const totalPages=Math.ceil(lengthCm/pageHeight);

  const doc=new jsPDF({
    orientation:"portrait",
    unit:"cm",
    format:[widthCm,pageHeight]
  });

  for(let p=0;p<totalPages;p++){

    if(p>0) doc.addPage([widthCm,pageHeight]);

    const pageTop=p*pageHeight;

    for(let node of layer.children){

      if(node.className!=="Image") continue;

      const realX=node.x()/SCALE/100;
      const realY=node.y()/SCALE/100;
      const realW=node.width()/SCALE/100;
      const realH=node.height()/SCALE/100;

      if(realY+realH>pageTop && realY<pageTop+pageHeight){

        doc.addImage(
          node.image().src,
          "JPEG",
          realX,
          realY-pageTop,
          realW,
          realH
        );
      }
    }
  }

  window.open(doc.output("bloburl"));
}

</script>
</body>
</html>
