<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>AUTO LAYOUT – Production</title>

<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/utif@3.1.0/UTIF.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial;
  background:#f4f6f9;
  display:flex;
  flex-direction:column;
  height:100vh;
}
.topbar{
  background:#0b1d3a;
  color:white;
  padding:14px 24px;
  display:flex;
  justify-content:space-between;
}
.status-badge{
  background:#1abc9c;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
}
.main{
  flex:1;
  display:flex;
  overflow:hidden;
}
#controls{
  width:340px;
  background:white;
  border-right:1px solid #e0e6ed;
  padding:24px;
  overflow-y:auto;
}
input{
  width:100%;
  padding:8px;
  margin-bottom:12px;
}
button{
  width:100%;
  padding:10px;
  margin-bottom:8px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.btn-primary{background:#1f3c88;color:white;}
.btn-secondary{background:#ecf0f1;}
#workspace{
  flex:1;
  padding:24px;
  overflow:auto;
}
.canvas-wrapper{
  background:white;
  padding:20px;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
.footer-info{
  font-size:12px;
  margin-top:15px;
}
</style>
</head>

<body>

<div class="topbar">
  <div><strong>AUTO LAYOUT</strong> – Production System</div>
  <div class="status-badge" id="systemStatus">READY</div>
</div>

<div class="main">

<div id="controls">

<label>Carpet Width (m)</label>
<input type="number" id="width" value="4">

<label>Carpet Length (m)</label>
<input type="number" id="length" value="40">

<label>Gap (cm)</label>
<input type="number" id="gap" value="10">

<label>Upload Images</label>
<input type="file" id="upload" multiple>

<button class="btn-primary" onclick="autoLayout()">Smart Auto Layout</button>
<button class="btn-primary" onclick="exportPDF()">Export Production PDF</button>
<button class="btn-secondary" onclick="initStage()">Reset Project</button>

<div class="footer-info">
Images: <span id="imageCount">0</span><br>
Used Area: <span id="usedArea">0%</span><br>
Carpet Size: <span id="carpetSize">0 x 0 cm</span>
</div>

</div>

<div id="workspace">
<div class="canvas-wrapper">
<div id="container"></div>
</div>
</div>

</div>

<script>
const SCALE = 0.1;
let stage, layer;

function initStage(){

  const widthCm = width.value * 100;
  const lengthCm = length.value * 100;

  const widthPx = widthCm * SCALE;
  const heightPx = lengthCm * SCALE;

  container.innerHTML="";

  stage = new Konva.Stage({
    container:'container',
    width:widthPx,
    height:heightPx
  });

  layer = new Konva.Layer();
  stage.add(layer);

  layer.add(new Konva.Rect({
    x:0,y:0,
    width:widthPx,
    height:heightPx,
    stroke:"black",
    strokeWidth:2
  }));

  updateAreaUsage();
}

initStage();
width.onchange = initStage;
length.onchange = initStage;

upload.addEventListener('change', function(e){

  Array.from(e.target.files).forEach(file=>{

    const reader=new FileReader();

    reader.onload=function(evt){

      const imgObj=new Image();

      imgObj.onload=function(){

        const img=new Konva.Image({
          image:imgObj,
          x:0,y:0,
          width:200,height:200,
          draggable:true,
          dragBoundFunc:function(pos){
            return{
              x:Math.max(0,Math.min(pos.x,stage.width()-this.width())),
              y:Math.max(0,Math.min(pos.y,stage.height()-this.height()))
            };
          }
        });

        layer.add(img);
        layer.draw();
        updateAreaUsage();
        updateImageCount();
      };

      imgObj.src=evt.target.result;
    };

    reader.readAsDataURL(file);
  });
});

function updateImageCount(){
  imageCount.innerText =
    layer.children.filter(n=>n.className==="Image").length;
}

function autoLayout(){

  const gap = gapInput = gap.value * SCALE;

  let x=0,y=0,rowHeight=0;

  const images=layer.children
    .filter(n=>n.className==="Image")
    .sort((a,b)=>(b.width()*b.height())-(a.width()*a.height()));

  images.forEach(img=>{

    if(x+img.width()>stage.width()){
      x=0;
      y+=rowHeight+gapInput;
      rowHeight=0;
    }

    img.position({x,y});
    x+=img.width()+gapInput;
    rowHeight=Math.max(rowHeight,img.height());
  });

  layer.draw();
  updateAreaUsage();
}

function updateAreaUsage(){

  const widthCm = width.value*100;
  const lengthCm = length.value*100;
  const carpetArea = widthCm*lengthCm;

  let used=0;

  layer.children.forEach(n=>{
    if(n.className==="Image"){
      const realW = n.width()/SCALE;
      const realH = n.height()/SCALE;
      used+=realW*realH;
    }
  });

  usedArea.innerText=((used/carpetArea)*100).toFixed(2)+"%";
  carpetSize.innerText=widthCm+" x "+lengthCm+" cm";
}

async function exportPDF(){

  const { jsPDF } = window.jspdf;

  const widthCm = width.value*100;
  const lengthCm = length.value*100;

  const doc=new jsPDF({
    orientation:"portrait",
    unit:"cm",
    format:[widthCm,lengthCm]
  });

  for(let node of layer.children){

    if(node.className!=="Image") continue;

    doc.addImage(
      node.image().src,
      "JPEG",
      node.x()/SCALE,
      node.y()/SCALE,
      node.width()/SCALE,
      node.height()/SCALE
    );
  }

  window.open(doc.output("bloburl"));
}
</script>
</body>
</html>
